
<!DOCTYPE html>
<html lang='ar' dir='rtl'>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    {% load static %}
    <link rel='stylesheet' type='text/css' media='screen' href="{% static 'SEC_App/style.css' %}?version=21">
    <script  type="module" src="{% static 'SEC_App/search.js' %}" defer></script>

    <!-- Tajawal font -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal&display=swap" rel="stylesheet">

    <!-- chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.3.2/chart.min.js" ></script>

    <!-- jspdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>
    
    <title>النتائج والتحليلات</title>
</head>
<body>  
  <div id='pdf-container'>
  <h1>النتائج والتحليلات <div id="home-button-div" style="display: inline-block;">
    <a href="{% url 'SEC_App:search' %}"><img id='home-button' src="{% static 'SEC_App/home-page.svg' %}" alt="الصفحة الرئيسية" style='display: "inline-block"'></a>
  </div></h1>
  <div id='search-details'>
    <table>
      <tr>
        <th>كلمات البحث:</th>
        <td>{{req.keyword}}</td>
        <td id="home-button-column"></td>
      </tr>
    </table>
    <table>
      <tr>
        <th>من:</th>
        <td>{{from_date}}</td>
        <th>إلى:</th>
        <td>{{to_date}}</td>
      </tr>
    </table>
    <form action="{% url 'SEC_App:history' %}" method="POST">
      {% csrf_token %}
      <label for="query_num">البحث رقم</label>
                <select name="query_num" id="query_num" onchange="this.form.submit()">
                    {% for req_obj in req_list %}
                      {% if req_obj.id == req.id %}
                        <option value={{req_obj.id}} selected="selected" size=5>{{req_obj.id}}</option>
                      {% else %}
                        <option value={{req_obj.id}}>{{req_obj.id}} تاريخ الطلب: {{req_obj.date_time}} كلمات البحث: "{{req_obj.keyword}}" من: {{req_obj.true_start}} إلى: {{req_obj.true_end}}</option>
                      {% endif %}
                    {% endfor %}
                </select>
          </form>
  </div>
  <br><br>
  <div class="center-wrapper">
  <div id="pie-chart-container" class="relative">
    <!-- <span>تحليل المشاعر</span> -->
    <canvas id="sentiment-pie-chart"></canvas>
    <div class="absolute-center text-center">
      <p>عدد التغريدات:</p>
      <p>{{num_tweets}}</p>
    </div>
  </div>
  <div id="myCahrt-container">
    <span>التفاعل مع التغريدات</span>
    <canvas id="reactions-bar-chart" width="30%" height="30%" style='display: "inline-block" !important;'></canvas>
  </div>
 </div>
  <br><br><br>
  <div id="week-days-container" style='display: "inline-block"'>
    <canvas id="myChart2" width="30%" height="30%" style='display: "inline-block" !important;'></canvas>
    <button id="2" type="button" >ساعات</button>
    <button id="0" type="button" >أيام</button>
    <button id="1" type="button" >أشهر</button>
  </div>
  <div id="wordcloud-container">
    <span>سحابة الكلمات</span>
    <br><br>
    <img src="{% static 'SEC_App/wordcloud.png' %}?version={{req.id}}" alt="wordcloud" style='display: "inline-block"'>
  </div>
  <div id='tweets-list'>
  <h2>من التغريدات</h2>
    <table>
    {% for tweet in tweets_list %}
        <tr>
          <td class="counter">{{ forloop.counter }}</td>
          <td>{{ tweet }}</td>
        </tr>
    {% endfor %}
    </table>
  </div>


<script>
  var reactions = JSON.parse("{{ reactions|escapejs }}");

  var likes = reactions['likes'];
  var replies = reactions['replies'];
  var retweets = reactions['retweets'];


  var ctx = document.getElementById("reactions-bar-chart");

  // setup
  const DATA_COUNT = 3;

  const labels = ['سلبي', 'طبيعي', 'إيجابي'];
  const data = {
    labels: labels,
    datasets: [
      {
        label: 'إعجابات',
        data: likes,
        backgroundColor: 'rgba(255, 99, 132, 1)',
        borderColor: 'rgba(255, 99, 132, 1)',
        borderWidth: 1,
        hoverOffset: 4
      },
      {
        label: 'إعادات التغريد',
        data: retweets,
        backgroundColor: 'rgba(54, 162, 235, 1)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1,
        hoverOffset: 4
      },
      {
        label: 'الردود',
        data: replies,
        backgroundColor: 'rgba(255, 206, 86, 1)', 
        borderColor: 'rgba(255, 206, 86, 1)',
        borderWidth: 1,
        hoverOffset: 4
      },
    ]
  };

  // config
  const config = {
      type: 'bar',
      data: data,
      options: {
        plugins: {
          legend: {
        labels: {
          color: 'rgba(240, 248, 255, 1)', 
          font: {
            size: 14,
            family: "'Tajawal', sans-serif",
          }
        }
      },
          title: {
            display: true,
            text: '',
            fontColor: 'rgba(240, 248, 255, 1)',
          },
        },
        responsive: true,
        scales: {
          x: {
            stacked: true,
            ticks: {
              color: 'rgba(240, 248, 255, 1)', 
              font: {
              size: 14, 
              family: "'Tajawal', sans-serif",
              },
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.3)',
            },
          },
          y: {
            stacked: true,
            ticks: {
              color: 'rgba(240, 248, 255, 1)', 
              font: {
              size: 14, 
              family: "'Tajawal', sans-serif",
              },
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.3)',
            },
          }
        }
      }
    };
  // 'rgba(240, 248, 255, 1)'
  // action
  const actions = [
      {
        name: 'Randomize',
        handler(chart) {
          chart.data.datasets.forEach(dataset => {
            dataset.data = Utils.numbers({count: chart.data.labels.length, min: 0});
          });
          chart.update();
        }
      },
    ];

  var chart = new Chart(ctx, config, actions)
</script>
<script>
  var period_data = JSON.parse("{{ period_data|escapejs }}");

  var negativeData = period_data['negativeDays'];
  var neutralData = period_data['neutralDays'];
  var positiveData = period_data['positiveDays'];

  var NegativeD = period_data['negativeMonths'];
  var NatD = period_data['neutralMonths'];
  var postiveD = period_data['positiveMonths'];

  var postiveH = period_data['positiveHours'];
  var NegativeH = period_data['negativeHours'];
  var NatH = period_data['neutralHours'];

  var ctx2 = document.getElementById("myChart2");

  var chart3 , chart2;
  function Days_period(){

  // setup
  const DATA_COUNT2 = 7;
  const NUMBER_CFG = {count: DATA_COUNT2, min: -100, max: 100};

  const labels2 = ['السبت','الجمعة','الخميس','الاربعاء','الثلاثاء','الاثنين','الاحد'];

  const data2 = {
    labels: labels2,
    datasets: [
      {
        label: 'ايجابي',
        data: positiveData,
        borderColor: 'rgba(255, 206, 86, 1)',
        backgroundColor: 'rgba(255, 206, 86, 0.2)',
        yAxisID: 'y',
      },
      {
        label: 'سلبي',
        data: negativeData,
        borderColor: 'rgba(255, 99, 132, 1)',
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        yAxisID: 'y',
      },
      {
        label: 'طبيعي',
        data: neutralData,
        borderColor: 'rgba(54, 162, 235, 1)',
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        yAxisID: 'y',
      }
    ]
  };

  // config
  const config2 = {
    type: 'line',
    data: data2,
    options: {
      responsive: true,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      stacked: false,
      plugins: {
        legend: {
        labels: {
          color: 'rgba(240, 248, 255, 1)', 
          font: {
            size: 14,
            family: "'Tajawal', sans-serif",
          }
        }
      },
        title: {
          display: true,
          text: 'تفاعل مع الأيام',
          color: 'rgba(240, 248, 255, 1)',
          font: {
          size: 22,
          family: "'Tajawal', sans-serif",
          },
        }
      },
      scales: {
        x: {
          ticks: {
            color: 'rgba(240, 248, 255, 1)', 
            font: {
            size: 14, 
            family: "'Tajawal', sans-serif",
            },
            },
          grid: {
            color: 'rgba(255, 255, 255, 0.3)',
        },
        },
        y: {
          type: 'linear',
          display: true,
          position: 'left',
          ticks: {
            color: 'rgba(240, 248, 255, 1)', 
            font: {
            size: 14, 
            family: "'Tajawal', sans-serif",
            },
            },
          grid: {
            color: 'rgba(255, 255, 255, 0.3)',
        },
        },
      }
    },
  };
  const actions2 = [
    {
      name: 'Randomize',
      handler(chart2) {
        chart2.data.datasets.forEach(dataset => {
          dataset.data = Utils.numbers({count: chart2.data.labels.length, min: -100, max: 100});
        });
        chart2.update();
      }
    },
  ];
  var chart2 = new Chart(ctx2, config2, actions2)

  document.getElementById("1").addEventListener('click', () => {
  chart2.destroy();
  Month_period();
});
document.getElementById("2").addEventListener('click', () => {
  chart2.destroy();
  Hours_period();
});
  }

  function Month_period(){
  // setup
  const DATA_COUNT3 = 12;
  const NUMBER_CFG = {count: DATA_COUNT3, min: -100, max: 100};

  const labels3 = ['ديسمبر', 'نوفمبر', 'أكتوبر', 'سبتمبر', 'أغسطس', 'يوليو', 'يونيو', 'مايو', 'أبريل', 'مارس', 'فبراير', 'يناير'];

  const data3 = {
    labels: labels3,
    datasets: [
      {
        label: 'ايجابي',
        data: postiveD,
        borderColor: 'rgba(255, 206, 86, 1)',
        backgroundColor: 'rgba(255, 206, 86, 0.2)',
        yAxisID: 'y',
      },
      {
        label: 'سلبي',
        data: NegativeD,
        borderColor: 'rgba(255, 99, 132, 1)',
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        yAxisID: 'y',
      },
      {
        label: 'طبيعي',
        data: NatD,
        borderColor: 'rgba(54, 162, 235, 1)',
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        yAxisID: 'y',
      }
    ]
  };

  // config
  const config3 = {
    type: 'line',
    data: data3,
    options: {
      responsive: true,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      stacked: false,
      plugins: {
        legend: {
        labels: {
          color: 'rgba(240, 248, 255, 1)', 
          font: {
            size: 14,
            family: "'Tajawal', sans-serif",
          }
        }
      },
        title: {
          display: true,
          text: 'تفاعل مع الاشهر',
          color: 'rgba(240, 248, 255, 1)',
          font: {
          size: 22,
          family: "'Tajawal', sans-serif",
          },
        }
      },
      scales: {
        x :{
          ticks: {
            color: 'rgba(240, 248, 255, 1)', 
            font: {
            size: 14, 
            family: "'Tajawal', sans-serif",
            },
          },
            grid: {
              color: 'rgba(255, 255, 255, 0.3)',
          },
        },
        y: {
          type: 'linear',
          display: true,
          position: 'left',
          ticks: {
            color: 'rgba(240, 248, 255, 1)', 
            font: {
            size: 14, 
            family: "'Tajawal', sans-serif",
            },
          },
          grid: {
            color: 'rgba(255, 255, 255, 0.3)',
          },
        },
      }
    },
  };
  const actions3 = [
    {
      name: 'Randomize',
      handler(chart3) {
        chart3.data.datasets.forEach(dataset => {
          dataset.data = Utils.numbers({count: chart3.data.labels.length, min: -100, max: 100});
        });
        chart3.update();
      }
    },
  ];
  chart3 = new Chart(ctx2, config3, actions3)
  // add event listeners for the buttons
document.getElementById("0").addEventListener('click', () => {
  chart3.destroy();
  Days_period();
});
document.getElementById("2").addEventListener('click', () => {
  chart3.destroy();
  Hours_period()
});
  }
  Days_period();

function Hours_period(){

  // setup
  const DATA_COUNT4 = 24;
  const NUMBER_CFG = {count: DATA_COUNT4, min: -100, max: 100};

  const labels4 = ['00','01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23'];

  const data4 = {
    labels: labels4,
    datasets: [
      {
        label: 'ايجابي',
        data: postiveH,
        borderColor: 'rgba(255, 206, 86, 1)',
        backgroundColor: 'rgba(255, 206, 86, 0.2)',
        yAxisID: 'y',
      },
      {
        label: 'سلبي',
        data: NegativeH,
        borderColor: 'rgba(255, 99, 132, 1)',
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        yAxisID: 'y',
      },
      {
        label: 'طبيعي',
        data: NatH,
        borderColor: 'rgba(54, 162, 235, 1)',
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        yAxisID: 'y',
      }
    ]
  };

  // config
  const config4 = {
    type: 'line',
    data: data4,
    options: {
      responsive: true,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      stacked: false,
      plugins: {
        legend: {
        labels: {
          color: 'rgba(240, 248, 255, 1)', 
          font: {
            size: 14,
            family: "'Tajawal', sans-serif",
          }
        }
      },
        title: {
          display: true,
          text: 'تفاعل مع الساعات',
          color: 'rgba(240, 248, 255, 1)',
          font: {
          size: 22,
          family: "'Tajawal', sans-serif",
          },
        }
      },
      scales: {
        x :{
          ticks: {
            color: 'rgba(240, 248, 255, 1)', 
            font: {
            size: 14, 
            family: "'Tajawal', sans-serif",
            },
          },
            grid: {
              color: 'rgba(255, 255, 255, 0.3)',
          },
        },
        y: {
          type: 'linear',
          display: true,
          position: 'left',
          ticks: {
            color: 'rgba(240, 248, 255, 1)', 
            font: {
            size: 14, 
            family: "'Tajawal', sans-serif",
            },
          },
          grid: {
            color: 'rgba(255, 255, 255, 0.3)',
          },
        },
      }
    },
  };
  const actions4 = [
    {
      name: 'Randomize',
      handler(chart2) {
        chart4.data.datasets.forEach(dataset => {
          dataset.data = Utils.numbers({count: chart4.data.labels.length, min: -100, max: 100});
        });
        chart4.update();
      }
    },
  ];
  var chart4 = new Chart(ctx2, config4, actions4)

  // add event listeners for the buttons
  document.getElementById("1").addEventListener('click', () => {
    chart4.destroy();
    Month_period()
  });
  document.getElementById("0").addEventListener('click', () => {
    chart4.destroy();
    Days_period()
  });
  }

</script>
<script>
  var reactions = JSON.parse("{{ sentiment_data|escapejs }}");

  var pie_ctx = document.getElementById("sentiment-pie-chart");
  //setup
  const data_pie = {
    labels: ['إيجابي', 'سلبي', 'طبيعي'],
    datasets: [
      {
        label: 'Sentiment',
        data: reactions['sentiment'],
        backgroundColor: [
        'rgb(255, 205, 86)',
        'rgb(255, 99, 132)',
        'rgb(54, 162, 235)'
        ],
        hoverOffset: 4
      }
    ]
  };

  //config
  const config_pie = {
  type: 'doughnut',
  data: data_pie,
  options: {
    responsive: true,
    plugins: {
      legend: {
        position: 'top',
        labels: {
          color: 'rgba(240, 248, 255, 1)',  
          font: {
            size: 14,
            family: "'Tajawal', sans-serif",
          }
        }
      },
      title: {
        display: true,
        text: ''
      }
    }
  },
  };

  //actions
  const actions_pie = [
  {
    name: 'Randomize',
    handler(chart) {
      chart.data.datasets.forEach(dataset => {
        dataset.data = Utils.numbers({count: chart.data.labels.length, min: 0, max: 100});
      });
      chart.update();
    }
  },
  {
    name: 'Add Dataset',
    handler(chart) {
      const data = chart.data;
      const newDataset = {
        label: 'Dataset ' + (data.datasets.length + 1),
        backgroundColor: [],
        data: [],
      };

      for (let i = 0; i < data.labels.length; i++) {
        newDataset.data.push(Utils.numbers({count: 1, min: 0, max: 100}));

        const colorIndex = i % Object.keys(Utils.CHART_COLORS).length;
        newDataset.backgroundColor.push(Object.values(Utils.CHART_COLORS)[colorIndex]);
      }

      chart.data.datasets.push(newDataset);
      chart.update();
    }
  },
  {
    name: 'Add Data',
    handler(chart) {
      const data = chart.data;
      if (data.datasets.length > 0) {
        data.labels.push('data #' + (data.labels.length + 1));

        for (var index = 0; index < data.datasets.length; ++index) {
          data.datasets[index].data.push(Utils.rand(0, 100));
        }

        chart.update();
      }
    }
  },
  {
    name: 'Remove Dataset',
    handler(chart) {
      chart.data.datasets.pop();
      chart.update();
    }
  },
  {
    name: 'Remove Data',
    handler(chart) {
      chart.data.labels.splice(-1, 1); // remove the label first

      chart.data.datasets.forEach(dataset => {
        dataset.data.pop();
      });

      chart.update();
    }
  }
];
var chart = new Chart(pie_ctx, config_pie, actions_pie)

</script>
</div>
<button id="btnPrint" onClick="generate()"> اطبع </h4>
<script>
  function generate()
{
  //Global Variable Declaration
  var base64Img = null;
  margins = {
  top: 70,
  bottom: 40,
  left: 30,
  width: 550
  };
  var pdf = new jsPDF('p', 'pt', 'a4');
  pdf.setFontSize(18);
  pdf.fromHTML(document.getElementById('pdf-container'), 
      margins.left, // x coord
      margins.top,
      {
      // y coord
      width: margins.width// max width of content on PDF
      },function(dispose) {
      headerFooterFormatting(pdf)
      }, 
      margins);
  
  var iframe = document.createElement('iframe');
  iframe.setAttribute('style','position:absolute;right:0; top:0; bottom:0; height:100%; width:650px; padding:20px;');
  document.body.appendChild(iframe);
  
  iframe.src = pdf.output('datauristring');
}

function headerFooterFormatting(doc)
{
    var totalPages  = doc.internal.getNumberOfPages();

    for(var i = totalPages; i >= 1; i--)
    { //make this page, the current page we are currently working on.
        doc.setPage(i);      
                      
        header(doc);
        
        footer(doc, i, totalPages);
        
    }
};

function header(doc)
{
    doc.setFontSize(30);
    doc.setTextColor(40);
    doc.setFontStyle('normal');
  
    if (base64Img) {
       doc.addImage(base64Img, 'JPEG', margins.left, 10, 40,40);        
    }
      
    doc.text("Report Header Template", margins.left + 50, 40 );
  
    doc.line(3, 70, margins.width + 43,70); // horizontal line
};

imgToBase64('wordcloud.jpg', function(base64) {
    base64Img = base64; 
});

// You could either use a function similar to this or preconvert an image with, for example, http://dopiaza.org/tools/datauri
// http://stackoverflow.com/questions/6150289/how-to-convert-image-into-base64-string-using-javascript
function imgToBase64(url, callback, imgVariable) {
 
 if (!window.FileReade) {
     callback(null);
     return;
 }
 var xhr = new XMLHttpRequest();
 xhr.responseType = 'blob';
 xhr.onload = function() {
     var reader = new FileReader();
     reader.onloadend = function() {
   imgVariable = reader.result.replace('text/xml', 'image/jpeg');
         callback(imgVariable);
     };
     reader.readAsDataURL(xhr.response);
 };
 xhr.open('GET', url);
 xhr.send();
};

</script>
</body>
</html>

<!-- return sum(range(0,max(nums)))-sum(nums) if sum(range(0,max(nums)))-sum(nums) != 0 else max(nums)+1 -->